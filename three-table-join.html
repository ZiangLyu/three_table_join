<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸‰è¡¨åˆå¹¶æŸ¥è¯¢ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 16px;
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        .section {
            margin-bottom: 40px;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 2px solid #e9ecef;
        }

        .section-title {
            font-size: 20px;
            color: #374151;
            margin-bottom: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .upload-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
        }

        .upload-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            border: 2px solid #e9ecef;
        }

        .upload-card h3 {
            font-size: 16px;
            color: #374151;
            margin-bottom: 12px;
        }

        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
        }

        .upload-area:hover {
            background: #f3f4f6;
            border-color: #5568d3;
        }

        .upload-area.dragover {
            background: #eef2ff;
            border-color: #4f46e5;
        }

        .upload-area input {
            display: none;
        }

        .upload-icon {
            font-size: 40px;
            margin-bottom: 10px;
        }

        .upload-text {
            color: #667eea;
            font-weight: 600;
            font-size: 15px;
            margin-bottom: 8px;
        }

        .upload-hint {
            color: #6b7280;
            font-size: 13px;
        }

        .instructions {
            background: #f0f9ff;
            border-left: 4px solid #3b82f6;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }

        .instructions h4 {
            color: #1e40af;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .instructions ul {
            margin-left: 20px;
            color: #1e3a8a;
            line-height: 1.8;
        }

        .instructions li {
            margin-bottom: 5px;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-group {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .filter-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
            margin-bottom: 20px;
        }

        .filter-item label {
            display: block;
            font-size: 14px;
            margin-bottom: 5px;
            color: #4b5563;
            font-weight: 500;
        }

        .filter-item input,
        .filter-item select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
        }

        .filter-item input:focus,
        .filter-item select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.15);
        }

        .table-container {
            overflow-x: auto;
            border-radius: 10px;
            border: 1px solid #e5e7eb;
            background: white;
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: #f3f4f6;
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
            white-space: nowrap;
        }

        th {
            font-weight: 600;
            color: #374151;
            font-size: 14px;
            position: sticky;
            top: 0;
            background: #f3f4f6;
            z-index: 1;
        }

        td {
            color: #6b7280;
            font-size: 14px;
        }

        tbody tr:hover {
            background: #f9fafb;
        }

        .status-message {
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 14px;
        }

        .status-success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #10b981;
        }

        .status-error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #ef4444;
        }

        .status-info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #3b82f6;
        }

        .status-warning {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #f59e0b;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #9ca3af;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-primary {
            background: #dbeafe;
            color: #1e40af;
        }

        .badge-success {
            background: #d1fae5;
            color: #065f46;
        }

        .pagination-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            padding: 20px;
            background: white;
            border-radius: 10px;
            border: 1px solid #e5e7eb;
            flex-wrap: wrap;
            gap: 15px;
        }

        .pagination-info {
            color: #6b7280;
            font-size: 14px;
        }

        .pagination-info strong {
            color: #374151;
            font-weight: 600;
        }

        .pagination-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .page-btn {
            padding: 8px 16px;
            border: 1px solid #e5e7eb;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #374151;
            transition: all 0.3s;
        }

        .page-btn:hover:not(:disabled) {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .page-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .page-numbers {
            display: flex;
            gap: 5px;
        }

        .page-number {
            min-width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #e5e7eb;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #374151;
            transition: all 0.3s;
        }

        .page-number:hover {
            background: #f3f4f6;
            border-color: #667eea;
        }

        .page-number.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .page-ellipsis {
            min-width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #9ca3af;
            font-size: 14px;
        }

        .page-size-selector {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .page-size-selector label {
            color: #6b7280;
            font-size: 14px;
        }

        .page-size-selector select {
            padding: 8px 12px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            background: white;
            color: #374151;
        }

        .page-size-selector select:focus {
            outline: none;
            border-color: #667eea;
        }

        .product-list {
            max-width: 300px;
            white-space: normal;
            word-wrap: break-word;
        }

        .region-summary {
            margin-top: 25px;
            padding: 20px;
            background: white;
            border-radius: 10px;
            border: 2px solid #e9ecef;
        }

        .region-summary-title {
            font-size: 18px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .region-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .region-card {
            background: linear-gradient(135deg, #f0f4ff 0%, #e8ecff 100%);
            border-radius: 10px;
            padding: 18px;
            border: 2px solid #c7d2fe;
            transition: all 0.3s;
            cursor: pointer;
            position: relative;
            user-select: none;
        }

        .region-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.25);
            border-color: #818cf8;
        }

        .region-card.active {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(79, 70, 229, 0.35);
            border-color: #4f46e5;
            background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);
        }

        .region-card-name {
            font-size: 15px;
            font-weight: 600;
            color: #4338ca;
            margin-bottom: 8px;
            word-break: break-all;
        }

        .region-card-count {
            font-size: 28px;
            font-weight: 700;
            color: #ef4444;
            line-height: 1;
        }

        .region-card-unit {
            font-size: 13px;
            color: #6b7280;
            margin-top: 4px;
        }

        .region-card-hint {
            font-size: 12px;
            color: #818cf8;
            margin-top: 8px;
            font-weight: 500;
        }

        .region-card.active .region-card-hint {
            color: #4338ca;
        }

        .area-detail-panel {
            overflow: hidden;
            max-height: 0;
            opacity: 0;
            transition: max-height 0.4s ease, opacity 0.3s ease, margin 0.3s ease, padding 0.3s ease;
            background: linear-gradient(135deg, #f5f3ff 0%, #ede9fe 100%);
            border-radius: 12px;
            border: 2px solid #c4b5fd;
            margin-bottom: 0;
            padding: 0 20px;
        }

        .area-detail-panel.open {
            max-height: 2000px;
            opacity: 1;
            margin-bottom: 15px;
            padding: 20px;
        }

        .area-detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .area-detail-title {
            font-size: 16px;
            font-weight: 600;
            color: #5b21b6;
        }

        .area-detail-close {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 1px solid #c4b5fd;
            background: white;
            color: #7c3aed;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            line-height: 1;
        }

        .area-detail-close:hover {
            background: #7c3aed;
            color: white;
            border-color: #7c3aed;
        }

        .area-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(170px, 1fr));
            gap: 12px;
            margin-bottom: 15px;
        }

        .area-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            border: 1px solid #ddd6fe;
            transition: all 0.2s;
        }

        .area-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(124, 58, 237, 0.15);
            border-color: #a78bfa;
        }

        .area-card-name {
            font-size: 14px;
            font-weight: 600;
            color: #6d28d9;
            margin-bottom: 6px;
            word-break: break-all;
        }

        .area-card-count {
            font-size: 22px;
            font-weight: 700;
            color: #ef4444;
            line-height: 1;
        }

        .area-card-unit {
            font-size: 12px;
            color: #6b7280;
            margin-top: 3px;
        }

        .cleanup-section {
            background: #fef2f2;
            border: 2px solid #fca5a5;
        }

        .cleanup-warning {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }

        .cleanup-warning h4 {
            color: #92400e;
            margin-bottom: 10px;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .cleanup-warning p {
            color: #78350f;
            line-height: 1.6;
            margin-bottom: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ä¸‰è¡¨åˆå¹¶æŸ¥è¯¢ç³»ç»Ÿ</h1>
            <p>ç»Ÿè®¡å®¢æˆ·æ‹œè®¿æ¬¡æ•°ä¸æ‰«ç æƒ…å†µ</p>
        </div>

        <div class="content">
            <!-- ä¸Šä¼ åŒºåŸŸ -->
            <div class="section">
                <div class="section-title">
                    <span>Step 1</span> ä¸Šä¼ ä¸‰ä¸ªæ•°æ®è¡¨
                </div>

                <div class="upload-row">
                    <!-- Visit ä¸Šä¼  -->
                    <div class="upload-card">
                        <h3>æ‹œè®¿æ˜ç»†è®°å½•è¡¨</h3>
                        <div class="instructions">
                            <h4>æ–‡ä»¶æ ¼å¼è¦æ±‚ï¼š</h4>
                            <ul>
                                <li>æ”¯æŒ Excel (.xlsx, .xls) æ–‡ä»¶</li>
                                <li>å¿…é¡»åŒ…å«åˆ—ï¼šæ‹œè®¿è®°å½•ç¼–å·ã€æ‹œè®¿å¼€å§‹æ—¶é—´ã€æ‹œè®¿ç»“æŸæ—¶é—´ã€æ‹œè®¿äººã€å®¢æˆ·åç§°ã€å®¢æˆ·ç¼–ç ã€æ‹œè®¿ç”¨æ—¶</li>
                            </ul>
                        </div>
                        <div class="upload-area" id="visitUploadArea" onclick="document.getElementById('fileInput').click()">
                            <div class="upload-icon">ğŸ“‹</div>
                            <p class="upload-text">ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ æ‹œè®¿æ˜ç»†è®°å½•è¡¨</p>
                            <p class="upload-hint">æ”¯æŒ .xlsx, .xls æ ¼å¼</p>
                            <input type="file" id="fileInput" accept=".xlsx,.xls" onchange="handleFileSelect(event)">
                        </div>
                        <div id="uploadStatus"></div>
                    </div>

                    <!-- Terminal ä¸Šä¼  -->
                    <div class="upload-card">
                        <h3>ç»ˆç«¯é—¨åº—æ¸…å•è¡¨</h3>
                        <div class="instructions">
                            <h4>æ–‡ä»¶æ ¼å¼è¦æ±‚ï¼š</h4>
                            <ul>
                                <li>æ”¯æŒ Excel (.xlsx, .xls) æ–‡ä»¶</li>
                                <li>å¿…é¡»åŒ…å«åˆ—ï¼šå®¢æˆ·ç¼–ç ã€å®¢æˆ·åç§°ã€æ‰€å±ç‰‡åŒºã€æ‰€å±å¤§åŒº</li>
                                <li>ç”¨äºè¡¥å……æ‹œè®¿æ˜ç»†è®°å½•è¡¨ä¸­å®¢æˆ·çš„å½’å±ä¿¡æ¯</li>
                            </ul>
                        </div>
                        <div class="upload-area" id="terminalUploadArea" onclick="document.getElementById('terminalFileInput').click()">
                            <div class="upload-icon">ğŸ¢</div>
                            <p class="upload-text">ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ ç»ˆç«¯é—¨åº—æ¸…å•è¡¨</p>
                            <p class="upload-hint">æ”¯æŒ .xlsx, .xls æ ¼å¼</p>
                            <input type="file" id="terminalFileInput" accept=".xlsx,.xls" onchange="handleTerminalFileSelect(event)">
                        </div>
                        <div id="terminalUploadStatus"></div>
                    </div>

                    <!-- Scan ä¸Šä¼  -->
                    <div class="upload-card">
                        <h3>æ‰«ç è®°å½•è¡¨</h3>
                        <div class="instructions">
                            <h4>æ–‡ä»¶æ ¼å¼è¦æ±‚ï¼š</h4>
                            <ul>
                                <li>æ”¯æŒ Excel (.xlsx, .xls) æ–‡ä»¶</li>
                                <li>å¿…é¡»åŒ…å«åˆ—ï¼šå®¢æˆ·ç¼–ç ã€äº§å“ç¼–ç ã€äº§å“åç§°</li>
                                <li>ç”¨äºç»Ÿè®¡å®¢æˆ·æ‰«ç æ¬¡æ•°å’Œå•†å“</li>
                            </ul>
                        </div>
                        <div class="upload-area" id="scanUploadArea" onclick="document.getElementById('scanFileInput').click()">
                            <div class="upload-icon">ğŸ“±</div>
                            <p class="upload-text">ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ æ‰«ç è®°å½•è¡¨</p>
                            <p class="upload-hint">æ”¯æŒ .xlsx, .xls æ ¼å¼</p>
                            <input type="file" id="scanFileInput" accept=".xlsx,.xls" onchange="handleScanFileSelect(event)">
                        </div>
                        <div id="scanUploadStatus"></div>
                    </div>
                </div>
            </div>

            <!-- æŸ¥è¯¢å’Œå±•ç¤ºåŒºåŸŸ -->
            <div class="section">
                <div class="section-title">
                    <span>Step 2</span> æŸ¥è¯¢ç»“æœ
                </div>

                <div class="filter-form">
                    <div class="filter-item">
                        <label for="customerName">å®¢æˆ·åç§°</label>
                        <input type="text" id="customerName">
                    </div>
                    <div class="filter-item">
                        <label for="customerCode">å®¢æˆ·ç¼–ç </label>
                        <input type="text" id="customerCode">
                    </div>
                    <div class="filter-item">
                        <label for="area">æ‰€å±ç‰‡åŒº</label>
                        <input type="text" id="area">
                    </div>
                    <div class="filter-item">
                        <label for="region">æ‰€å±å¤§åŒº</label>
                        <input type="text" id="region">
                    </div>
                </div>

                <div class="btn-group">
                    <button class="btn btn-primary" onclick="queryRecords()">
                        æ‰§è¡ŒæŸ¥è¯¢
                    </button>
                    <button class="btn btn-success" onclick="exportToExcel()" id="exportBtn" style="display: none;">
                        å¯¼å‡ºä¸º Excel
                    </button>
                </div>

                <div id="queryStatus"></div>

                <!-- å¤§åŒºç»Ÿè®¡åŒºåŸŸ -->
                <div id="regionSummaryContainer"></div>

                <div id="resultContainer"></div>

                <div id="paginationContainer" style="display: none;"></div>
            </div>

            <!-- æ¸…ç†æ•°æ®åº“åŒºåŸŸ -->
            <div class="section cleanup-section">
                <div class="section-title">
                    <span>Step 3</span> æ¸…ç†æ•°æ®åº“
                </div>

                <div class="cleanup-warning">
                    <h4>âš ï¸ è­¦å‘Š</h4>
                    <p><strong>æ­¤æ“ä½œå°†æ°¸ä¹…åˆ é™¤å½“å‰æ•°æ®åº“åŠå…¶ä¸­çš„æ‰€æœ‰è¡¨å’Œæ•°æ®ï¼</strong></p>
                    <p>åˆ é™¤åæ— æ³•æ¢å¤ï¼Œè¯·è°¨æ…æ“ä½œï¼</p>
                </div>

                <div class="btn-group">
                    <button class="btn btn-danger" onclick="cleanupDatabase()">
                        ğŸ—‘ï¸ åˆ é™¤æ•°æ®åº“
                    </button>
                </div>

                <div id="cleanupStatus"></div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        const API_URL = 'http://localhost:8013/api/audit_visit/three_table_join';
        let currentData = [];
        let currentPage = 1;
        let pageSize = 1000;
        let totalPages = 0;

        // å¤§åŒº -> ç‰‡åŒºç»Ÿè®¡çš„ç¼“å­˜æ•°æ®
        let regionAreaMap = {};
        // å½“å‰å±•å¼€çš„å¤§åŒºåç§°
        let expandedRegion = null;

        // ============ Visit æ–‡ä»¶ä¸Šä¼  ============
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            const statusDiv = document.getElementById('uploadStatus');
            statusDiv.innerHTML = '<div class="status-message status-info">æ­£åœ¨è¯»å–æ–‡ä»¶...</div>';

            const reader = new FileReader();

            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);

                    if (jsonData.length === 0) {
                        statusDiv.innerHTML = '<div class="status-message status-error">æ–‡ä»¶ä¸ºç©ºï¼Œè¯·æ£€æŸ¥æ–‡ä»¶å†…å®¹</div>';
                        return;
                    }

                    statusDiv.innerHTML = '<div class="status-message status-success">æ–‡ä»¶è¯»å–æˆåŠŸï¼Œå…± ' + jsonData.length + ' æ¡è®°å½•ï¼Œæ­£åœ¨ä¸Šä¼ ...</div>';
                    uploadVisitInBatches(jsonData);
                } catch (error) {
                    statusDiv.innerHTML = '<div class="status-message status-error">æ–‡ä»¶è§£æå¤±è´¥: ' + error.message + '</div>';
                }
            };

            reader.onerror = function() {
                statusDiv.innerHTML = '<div class="status-message status-error">æ–‡ä»¶è¯»å–å¤±è´¥</div>';
            };

            reader.readAsArrayBuffer(file);
        }

        async function uploadVisitInBatches(records) {
            const statusDiv = document.getElementById('uploadStatus');
            const BATCH_SIZE = 5000;
            const totalBatches = Math.ceil(records.length / BATCH_SIZE);
            let totalInserted = 0;

            try {
                for (let i = 0; i < totalBatches; i++) {
                    const batch = records.slice(i * BATCH_SIZE, (i + 1) * BATCH_SIZE);
                    statusDiv.innerHTML = '<div class="status-message status-info">æ­£åœ¨ä¸Šä¼ ç¬¬ ' + (i + 1) + '/' + totalBatches + ' æ‰¹ï¼ˆæ¯æ‰¹ ' + BATCH_SIZE + ' æ¡ï¼‰...</div>';

                    const response = await fetch(API_URL + '/uploadVisit', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ records: batch })
                    });

                    const result = await response.json();
                    if (!result.success) {
                        statusDiv.innerHTML = '<div class="status-message status-error">ç¬¬ ' + (i + 1) + ' æ‰¹ä¸Šä¼ å¤±è´¥: ' + result.error + '</div>';
                        return;
                    }
                    totalInserted += batch.length;
                }

                statusDiv.innerHTML = '<div class="status-message status-success">æ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼å…±å¯¼å…¥ ' + totalInserted + ' æ¡è®°å½•ã€‚</div>';
            } catch (error) {
                statusDiv.innerHTML = '<div class="status-message status-error">ä¸Šä¼ å¤±è´¥: ' + error.message + '</div>';
            }
        }

        // ============ Terminal æ–‡ä»¶ä¸Šä¼  ============
        function handleTerminalFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            const statusDiv = document.getElementById('terminalUploadStatus');
            statusDiv.innerHTML = '<div class="status-message status-info">æ­£åœ¨è¯»å–æ–‡ä»¶...</div>';

            const reader = new FileReader();

            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);

                    if (jsonData.length === 0) {
                        statusDiv.innerHTML = '<div class="status-message status-error">æ–‡ä»¶ä¸ºç©º</div>';
                        return;
                    }

                    statusDiv.innerHTML = '<div class="status-message status-success">æ–‡ä»¶è¯»å–æˆåŠŸï¼Œå…± ' + jsonData.length + ' æ¡è®°å½•ï¼Œæ­£åœ¨ä¸Šä¼ ...</div>';
                    uploadTerminalInBatches(jsonData);
                } catch (error) {
                    statusDiv.innerHTML = '<div class="status-message status-error">æ–‡ä»¶è§£æå¤±è´¥: ' + error.message + '</div>';
                }
            };

            reader.onerror = function() {
                statusDiv.innerHTML = '<div class="status-message status-error">æ–‡ä»¶è¯»å–å¤±è´¥</div>';
            };

            reader.readAsArrayBuffer(file);
        }

        async function uploadTerminalInBatches(records) {
            const statusDiv = document.getElementById('terminalUploadStatus');
            const BATCH_SIZE = 5000;
            const totalBatches = Math.ceil(records.length / BATCH_SIZE);
            let totalInserted = 0;

            try {
                for (let i = 0; i < totalBatches; i++) {
                    const batch = records.slice(i * BATCH_SIZE, (i + 1) * BATCH_SIZE);
                    statusDiv.innerHTML = '<div class="status-message status-info">æ­£åœ¨ä¸Šä¼ ç¬¬ ' + (i + 1) + '/' + totalBatches + ' æ‰¹...</div>';

                    const response = await fetch(API_URL + '/uploadTerminal', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ records: batch })
                    });

                    const result = await response.json();
                    if (!result.success) {
                        statusDiv.innerHTML = '<div class="status-message status-error">ç¬¬ ' + (i + 1) + ' æ‰¹ä¸Šä¼ å¤±è´¥: ' + result.error + '</div>';
                        return;
                    }
                    totalInserted += batch.length;
                }

                statusDiv.innerHTML = '<div class="status-message status-success">æ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼å…±å¯¼å…¥ ' + totalInserted + ' æ¡è®°å½•ã€‚</div>';
            } catch (error) {
                statusDiv.innerHTML = '<div class="status-message status-error">ä¸Šä¼ å¤±è´¥: ' + error.message + '</div>';
            }
        }

        // ============ Scan æ–‡ä»¶ä¸Šä¼  ============
        function handleScanFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            const statusDiv = document.getElementById('scanUploadStatus');
            statusDiv.innerHTML = '<div class="status-message status-info">æ­£åœ¨è¯»å–æ–‡ä»¶...</div>';

            const reader = new FileReader();

            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);

                    if (jsonData.length === 0) {
                        statusDiv.innerHTML = '<div class="status-message status-error">æ–‡ä»¶ä¸ºç©º</div>';
                        return;
                    }

                    statusDiv.innerHTML = '<div class="status-message status-success">æ–‡ä»¶è¯»å–æˆåŠŸï¼Œå…± ' + jsonData.length + ' æ¡è®°å½•ï¼Œæ­£åœ¨ä¸Šä¼ ...</div>';
                    uploadScanInBatches(jsonData);
                } catch (error) {
                    statusDiv.innerHTML = '<div class="status-message status-error">æ–‡ä»¶è§£æå¤±è´¥: ' + error.message + '</div>';
                }
            };

            reader.onerror = function() {
                statusDiv.innerHTML = '<div class="status-message status-error">æ–‡ä»¶è¯»å–å¤±è´¥</div>';
            };

            reader.readAsArrayBuffer(file);
        }

        async function uploadScanInBatches(records) {
            const statusDiv = document.getElementById('scanUploadStatus');
            const BATCH_SIZE = 5000;
            const totalBatches = Math.ceil(records.length / BATCH_SIZE);
            let totalInserted = 0;

            try {
                for (let i = 0; i < totalBatches; i++) {
                    const batch = records.slice(i * BATCH_SIZE, (i + 1) * BATCH_SIZE);
                    statusDiv.innerHTML = '<div class="status-message status-info">æ­£åœ¨ä¸Šä¼ ç¬¬ ' + (i + 1) + '/' + totalBatches + ' æ‰¹...</div>';

                    const response = await fetch(API_URL + '/uploadScan', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ records: batch })
                    });

                    const result = await response.json();
                    if (!result.success) {
                        statusDiv.innerHTML = '<div class="status-message status-error">ç¬¬ ' + (i + 1) + ' æ‰¹ä¸Šä¼ å¤±è´¥: ' + result.error + '</div>';
                        return;
                    }
                    totalInserted += batch.length;
                }

                statusDiv.innerHTML = '<div class="status-message status-success">æ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼å…±å¯¼å…¥ ' + totalInserted + ' æ¡è®°å½•ã€‚</div>';
            } catch (error) {
                statusDiv.innerHTML = '<div class="status-message status-error">ä¸Šä¼ å¤±è´¥: ' + error.message + '</div>';
            }
        }

        // ============ æŸ¥è¯¢ ============
        async function queryRecords() {
            const customerName = document.getElementById('customerName').value.trim();
            const customerCode = document.getElementById('customerCode').value.trim();
            const area = document.getElementById('area').value.trim();
            const region = document.getElementById('region').value.trim();

            const params = new URLSearchParams({
                customerName,
                customerCode,
                area,
                region
            });

            const statusDiv = document.getElementById('queryStatus');
            const resultDiv = document.getElementById('resultContainer');
            const paginationDiv = document.getElementById('paginationContainer');
            const regionSummaryDiv = document.getElementById('regionSummaryContainer');

            statusDiv.innerHTML = '<div class="status-message status-info">æ­£åœ¨æŸ¥è¯¢ä¸‰è¡¨åˆå¹¶æ•°æ®ï¼ˆTerminal LEFT JOIN Visit LEFT JOIN Scanï¼‰...</div>';
            resultDiv.innerHTML = '';
            paginationDiv.style.display = 'none';
            regionSummaryDiv.innerHTML = '';
            document.getElementById('exportBtn').style.display = 'none';

            expandedRegion = null;
            regionAreaMap = {};

            try {
                const response = await fetch(API_URL + '/getMergedData?' + params.toString());
                const result = await response.json();

                if (result.success) {
                    currentData = result.data;
                    currentPage = 1;

                    if (currentData.length === 0) {
                        statusDiv.innerHTML = '<div class="status-message status-info">æœªæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„è®°å½•</div>';
                        resultDiv.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“­</div><h3>æš‚æ— ç¬¦åˆæ¡ä»¶çš„è®°å½•</h3><p>è¯·å°è¯•è°ƒæ•´æŸ¥è¯¢æ¡ä»¶</p></div>';
                    } else {
                        totalPages = Math.ceil(currentData.length / pageSize);
                        statusDiv.innerHTML = '<div class="status-message status-success">æŸ¥è¯¢æˆåŠŸï¼æ‰¾åˆ° ' + currentData.length + ' æ¡è®°å½•ï¼Œå…± ' + totalPages + ' é¡µ</div>';
                        buildRegionAreaMap();
                        renderRegionSummary();
                        displayResults();
                        renderPagination();
                        document.getElementById('exportBtn').style.display = 'inline-flex';
                        paginationDiv.style.display = 'block';
                    }
                } else {
                    statusDiv.innerHTML = '<div class="status-message status-error">æŸ¥è¯¢å¤±è´¥: ' + result.error + '</div>';
                }
            } catch (error) {
                statusDiv.innerHTML = '<div class="status-message status-error">æŸ¥è¯¢å¤±è´¥: ' + error.message + '</div>';
            }
        }

        // ============ æ¸…ç†æ•°æ®åº“ ============
        async function cleanupDatabase() {
            if (!confirm('âš ï¸ è­¦å‘Šï¼šæ­¤æ“ä½œå°†æ°¸ä¹…åˆ é™¤å½“å‰æ•°æ®åº“åŠå…¶ä¸­çš„æ‰€æœ‰æ•°æ®ï¼\n\nç¡®å®šè¦ç»§ç»­å—ï¼Ÿ')) {
                return;
            }
            const statusDiv = document.getElementById('cleanupStatus');
            statusDiv.innerHTML = '<div class="status-message status-info">æ­£åœ¨åˆ é™¤æ•°æ®åº“...</div>';

            try {
                const response = await fetch(API_URL + '/cleanup', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const result = await response.json();

                if (result.success) {
                    statusDiv.innerHTML = '<div class="status-message status-success">âœ… æ•°æ®åº“å·²æˆåŠŸåˆ é™¤ï¼æ‰€æœ‰æ•°æ®å·²æ¸…ç©ºã€‚æ‚¨å¯ä»¥é‡æ–°ä¸Šä¼ æ•°æ®ã€‚</div>';
                    
                    // æ¸…ç©ºé¡µé¢æ•°æ®
                    currentData = [];
                    document.getElementById('uploadStatus').innerHTML = '';
                    document.getElementById('terminalUploadStatus').innerHTML = '';
                    document.getElementById('scanUploadStatus').innerHTML = '';
                    document.getElementById('queryStatus').innerHTML = '';
                    document.getElementById('resultContainer').innerHTML = '';
                    document.getElementById('regionSummaryContainer').innerHTML = '';
                    document.getElementById('paginationContainer').style.display = 'none';
                    document.getElementById('exportBtn').style.display = 'none';
                    
                    // æ¸…ç©ºæ–‡ä»¶é€‰æ‹©
                    document.getElementById('fileInput').value = '';
                    document.getElementById('terminalFileInput').value = '';
                    document.getElementById('scanFileInput').value = '';
                } else {
                    statusDiv.innerHTML = '<div class="status-message status-error">åˆ é™¤å¤±è´¥: ' + result.error + '</div>';
                }
            } catch (error) {
                statusDiv.innerHTML = '<div class="status-message status-error">åˆ é™¤å¤±è´¥: ' + error.message + '</div>';
            }
        }

        // ============ æ„å»ºå¤§åŒº->ç‰‡åŒºæ˜ å°„ ============
        function buildRegionAreaMap() {
            regionAreaMap = {};

            currentData.forEach(function(row) {
                var regionName = row.æ‰€å±å¤§åŒº || 'æœªçŸ¥å¤§åŒº';
                var areaName = row.æ‰€å±ç‰‡åŒº || 'æœªçŸ¥ç‰‡åŒº';

                if (!regionAreaMap[regionName]) {
                    regionAreaMap[regionName] = {};
                }
                if (!regionAreaMap[regionName][areaName]) {
                    regionAreaMap[regionName][areaName] = 0;
                }
                regionAreaMap[regionName][areaName]++;
            });
        }

        // ============ å¤§åŒºç»Ÿè®¡ ============
        function renderRegionSummary() {
            var regionSummaryDiv = document.getElementById('regionSummaryContainer');

            var regionCountMap = {};
            var totalCount = currentData.length;

            currentData.forEach(function(row) {
                var regionName = row.æ‰€å±å¤§åŒº || 'æœªçŸ¥å¤§åŒº';
                if (!regionCountMap[regionName]) {
                    regionCountMap[regionName] = 0;
                }
                regionCountMap[regionName]++;
            });

            var regionList = [];
            for (var key in regionCountMap) {
                if (regionCountMap.hasOwnProperty(key)) {
                    regionList.push({ name: key, count: regionCountMap[key] });
                }
            }
            regionList.sort(function(a, b) { return b.count - a.count; });

            var html = '<div class="region-summary">';
            html += '<div class="region-summary-title">ğŸ“Š å„å¤§åŒºå®¢æˆ·åˆ†å¸ƒç»Ÿè®¡</div>';

            html += '<div class="region-cards">';
            regionList.forEach(function(item) {
                var isActive = (expandedRegion === item.name);
                var escapedName = item.name.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                html += '<div class="region-card' + (isActive ? ' active' : '') + '" onclick="toggleRegionDetail(\'' + escapedName + '\')">';
                html += '<div class="region-card-name">' + item.name + '</div>';
                html += '<div class="region-card-count">' + item.count + '</div>';
                html += '<div class="region-card-unit">ä¸ªå®¢æˆ·</div>';
                html += '<div class="region-card-hint">' + (isActive ? '&#9650; æ”¶èµ·ç‰‡åŒºæ˜ç»†' : '&#9660; å±•å¼€ç‰‡åŒºæ˜ç»†') + '</div>';
                html += '</div>';
            });
            html += '</div>';

            html += '<div class="area-detail-panel' + (expandedRegion ? ' open' : '') + '" id="areaDetailPanel">';
            html += '<div id="areaDetailContent"></div>';
            html += '</div>';

            html += '</div>';

            regionSummaryDiv.innerHTML = html;

            if (expandedRegion) {
                renderAreaDetail(expandedRegion);
            }
        }

        function toggleRegionDetail(regionName) {
            if (expandedRegion === regionName) {
                expandedRegion = null;
                var panel = document.getElementById('areaDetailPanel');
                if (panel) {
                    panel.classList.remove('open');
                }
                updateCardStates();
            } else {
                expandedRegion = regionName;
                renderAreaDetail(regionName);
                var panel = document.getElementById('areaDetailPanel');
                if (panel) {
                    panel.classList.add('open');
                }
                updateCardStates();
                setTimeout(function() {
                    var panelEl = document.getElementById('areaDetailPanel');
                    if (panelEl) {
                        panelEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    }
                }, 100);
            }
        }

        function updateCardStates() {
            var cards = document.querySelectorAll('.region-card');
            cards.forEach(function(card) {
                var nameEl = card.querySelector('.region-card-name');
                var hintEl = card.querySelector('.region-card-hint');
                if (!nameEl || !hintEl) return;

                var cardName = nameEl.textContent;
                if (cardName === expandedRegion) {
                    card.classList.add('active');
                    hintEl.innerHTML = '&#9650; æ”¶èµ·ç‰‡åŒºæ˜ç»†';
                } else {
                    card.classList.remove('active');
                    hintEl.innerHTML = '&#9660; å±•å¼€ç‰‡åŒºæ˜ç»†';
                }
            });
        }

        function renderAreaDetail(regionName) {
            var contentDiv = document.getElementById('areaDetailContent');
            if (!contentDiv) return;

            var areaMap = regionAreaMap[regionName];
            if (!areaMap) {
                contentDiv.innerHTML = '<p style="color: #6b7280;">è¯¥å¤§åŒºä¸‹æ— ç‰‡åŒºæ•°æ®ã€‚</p>';
                return;
            }

            var areaList = [];
            var regionTotal = 0;
            for (var key in areaMap) {
                if (areaMap.hasOwnProperty(key)) {
                    areaList.push({ name: key, count: areaMap[key] });
                    regionTotal += areaMap[key];
                }
            }
            areaList.sort(function(a, b) { return b.count - a.count; });

            var html = '';
            html += '<div class="area-detail-header">';
            html += '<div class="area-detail-title"><span>' + regionName + '</span> - å„ç‰‡åŒºå®¢æˆ·åˆ†å¸ƒï¼ˆå…± ' + areaList.length + ' ä¸ªç‰‡åŒºï¼‰</div>';
            html += '<button class="area-detail-close" onclick="toggleRegionDetail(\'' + regionName.replace(/'/g, "\\'") + '\')">&times;</button>';
            html += '</div>';

            html += '<div class="area-cards">';
            areaList.forEach(function(item) {
                var percent = regionTotal > 0 ? ((item.count / regionTotal) * 100).toFixed(1) : '0.0';
                html += '<div class="area-card">';
                html += '<div class="area-card-name">' + item.name + '</div>';
                html += '<div class="area-card-count">' + item.count + '</div>';
                html += '<div class="area-card-unit">ä¸ªå®¢æˆ·ï¼ˆ' + percent + '%ï¼‰</div>';
                html += '</div>';
            });
            html += '</div>';

            contentDiv.innerHTML = html;
        }

        // ============ æ˜¾ç¤ºç»“æœï¼ˆåˆ†é¡µï¼‰ ============
        function displayResults() {
            const resultDiv = document.getElementById('resultContainer');

            const startIndex = (currentPage - 1) * pageSize;
            const endIndex = Math.min(startIndex + pageSize, currentData.length);
            const pageData = currentData.slice(startIndex, endIndex);

            let tableHTML = '<div class="table-container"><table><thead><tr>';
            tableHTML += '<th>åºå·</th>';
            tableHTML += '<th>å®¢æˆ·åç§°</th>';
            tableHTML += '<th>å®¢æˆ·ç¼–ç </th>';
            tableHTML += '<th>è¢«æ‹œè®¿æ€»æ¬¡æ•°</th>';
            tableHTML += '<th>æ‰«ç æ¬¡æ•°</th>';
            tableHTML += '<th>æ‰«ç å•†å“</th>';
            tableHTML += '<th>æ‰€å±ç‰‡åŒº</th>';
            tableHTML += '<th>æ‰€å±å¤§åŒº</th>';
            tableHTML += '</tr></thead><tbody>';

            pageData.forEach(function(row, index) {
                var globalIndex = startIndex + index + 1;
                tableHTML += '<tr>';
                tableHTML += '<td><strong>' + globalIndex + '</strong></td>';
                tableHTML += '<td>' + (row.å®¢æˆ·åç§° || '-') + '</td>';
                tableHTML += '<td>' + (row.å®¢æˆ·ç¼–ç  || '-') + '</td>';
                tableHTML += '<td><span class="badge badge-primary">' + (row.è¢«æ‹œè®¿æ€»æ¬¡æ•° || 0) + ' æ¬¡</span></td>';
                tableHTML += '<td><span class="badge badge-success">' + (row.æ‰«ç æ¬¡æ•° || 0) + ' æ¬¡</span></td>';
                tableHTML += '<td class="product-list">' + (row.æ‰«ç å•†å“ || '-') + '</td>';
                tableHTML += '<td>' + (row.æ‰€å±ç‰‡åŒº || '-') + '</td>';
                tableHTML += '<td>' + (row.æ‰€å±å¤§åŒº || '-') + '</td>';
                tableHTML += '</tr>';
            });

            tableHTML += '</tbody></table></div>';
            resultDiv.innerHTML = tableHTML;
        }

        // ============ åˆ†é¡µ ============
        function renderPagination() {
            const paginationDiv = document.getElementById('paginationContainer');

            const startIndex = (currentPage - 1) * pageSize + 1;
            const endIndex = Math.min(currentPage * pageSize, currentData.length);

            let html = '<div class="pagination-container">';
            html += '<div class="pagination-info">';
            html += 'æ˜¾ç¤º <strong>' + startIndex + '</strong> - <strong>' + endIndex + '</strong> æ¡ï¼Œ';
            html += 'å…± <strong>' + currentData.length + '</strong> æ¡è®°å½•';
            html += '</div>';

            html += '<div class="pagination-controls">';

            html += '<div class="page-size-selector">';
            html += '<label>æ¯é¡µæ˜¾ç¤ºï¼š</label>';
            html += '<select onchange="changePageSize(this.value)">';
            [100, 500, 1000, 2000].forEach(function(size) {
                html += '<option value="' + size + '"' + (pageSize === size ? ' selected' : '') + '>' + size + '</option>';
            });
            html += '</select></div>';

            html += '<button class="page-btn" onclick="goToPage(1)"' + (currentPage === 1 ? ' disabled' : '') + '>é¦–é¡µ</button>';
            html += '<button class="page-btn" onclick="goToPage(' + (currentPage - 1) + ')"' + (currentPage === 1 ? ' disabled' : '') + '>ä¸Šä¸€é¡µ</button>';

            html += '<div class="page-numbers">' + generatePageNumbers() + '</div>';

            html += '<button class="page-btn" onclick="goToPage(' + (currentPage + 1) + ')"' + (currentPage === totalPages ? ' disabled' : '') + '>ä¸‹ä¸€é¡µ</button>';
            html += '<button class="page-btn" onclick="goToPage(' + totalPages + ')"' + (currentPage === totalPages ? ' disabled' : '') + '>æœ«é¡µ</button>';

            html += '</div></div>';

            paginationDiv.innerHTML = html;
        }

        function generatePageNumbers() {
            let html = '';
            const maxVisible = 7;

            if (totalPages <= maxVisible) {
                for (let i = 1; i <= totalPages; i++) {
                    html += '<div class="page-number' + (i === currentPage ? ' active' : '') + '" onclick="goToPage(' + i + ')">' + i + '</div>';
                }
            } else {
                if (currentPage <= 4) {
                    for (let i = 1; i <= 5; i++) {
                        html += '<div class="page-number' + (i === currentPage ? ' active' : '') + '" onclick="goToPage(' + i + ')">' + i + '</div>';
                    }
                    html += '<div class="page-ellipsis">...</div>';
                    html += '<div class="page-number" onclick="goToPage(' + totalPages + ')">' + totalPages + '</div>';
                } else if (currentPage >= totalPages - 3) {
                    html += '<div class="page-number" onclick="goToPage(1)">1</div>';
                    html += '<div class="page-ellipsis">...</div>';
                    for (let i = totalPages - 4; i <= totalPages; i++) {
                        html += '<div class="page-number' + (i === currentPage ? ' active' : '') + '" onclick="goToPage(' + i + ')">' + i + '</div>';
                    }
                } else {
                    html += '<div class="page-number" onclick="goToPage(1)">1</div>';
                    html += '<div class="page-ellipsis">...</div>';
                    for (let i = currentPage - 1; i <= currentPage + 1; i++) {
                        html += '<div class="page-number' + (i === currentPage ? ' active' : '') + '" onclick="goToPage(' + i + ')">' + i + '</div>';
                    }
                    html += '<div class="page-ellipsis">...</div>';
                    html += '<div class="page-number" onclick="goToPage(' + totalPages + ')">' + totalPages + '</div>';
                }
            }

            return html;
        }

        function goToPage(page) {
            if (page < 1 || page > totalPages || page === currentPage) return;
            currentPage = page;
            displayResults();
            renderPagination();
            document.getElementById('resultContainer').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function changePageSize(newSize) {
            pageSize = parseInt(newSize);
            totalPages = Math.ceil(currentData.length / pageSize);
            currentPage = 1;
            displayResults();
            renderPagination();
        }

        // ============ å¯¼å‡º Excel ============
        function exportToExcel() {
            if (currentData.length === 0) {
                alert('æ²¡æœ‰æ•°æ®å¯ä»¥å¯¼å‡º');
                return;
            }

            var exportData = currentData.map(function(row, index) {
                return {
                    'åºå·': index + 1,
                    'å®¢æˆ·åç§°': row.å®¢æˆ·åç§° || '-',
                    'å®¢æˆ·ç¼–ç ': row.å®¢æˆ·ç¼–ç  || '-',
                    'è¢«æ‹œè®¿æ€»æ¬¡æ•°': row.è¢«æ‹œè®¿æ€»æ¬¡æ•° || 0,
                    'æ‰«ç æ¬¡æ•°': row.æ‰«ç æ¬¡æ•° || 0,
                    'æ‰«ç å•†å“': row.æ‰«ç å•†å“ || '-',
                    'æ‰€å±ç‰‡åŒº': row.æ‰€å±ç‰‡åŒº || '-',
                    'æ‰€å±å¤§åŒº': row.æ‰€å±å¤§åŒº || '-'
                };
            });

            var wb = XLSX.utils.book_new();
            var ws = XLSX.utils.json_to_sheet(exportData);
            ws['!cols'] = [
                { wch: 8 },
                { wch: 25 },
                { wch: 20 },
                { wch: 15 },
                { wch: 12 },
                { wch: 50 },
                { wch: 15 },
                { wch: 15 }
            ];
            XLSX.utils.book_append_sheet(wb, ws, 'ä¸‰è¡¨åˆå¹¶æŸ¥è¯¢ç»“æœ');

            var date = new Date().toISOString().split('T')[0];
            var filename = 'Visit_Terminal_Scan_åˆå¹¶æŸ¥è¯¢_' + date + '.xlsx';
            XLSX.writeFile(wb, filename);

            alert('å¯¼å‡ºæˆåŠŸï¼æ–‡ä»¶åï¼š' + filename + 'ï¼Œå…±å¯¼å‡º ' + currentData.length + ' æ¡è®°å½•');
        }

        // ============ æ‹–æ‹½ä¸Šä¼ æ”¯æŒ ============
        function setupDragDrop(areaId, fileInputId, handler) {
            var area = document.getElementById(areaId);

            area.addEventListener('dragover', function(e) {
                e.preventDefault();
                area.classList.add('dragover');
            });

            area.addEventListener('dragleave', function(e) {
                e.preventDefault();
                area.classList.remove('dragover');
            });

            area.addEventListener('drop', function(e) {
                e.preventDefault();
                area.classList.remove('dragover');
                var files = e.dataTransfer.files;
                if (files.length > 0) {
                    var fileInput = document.getElementById(fileInputId);
                    fileInput.files = files;
                    handler({ target: fileInput });
                }
            });
        }

        setupDragDrop('visitUploadArea', 'fileInput', handleFileSelect);
        setupDragDrop('terminalUploadArea', 'terminalFileInput', handleTerminalFileSelect);
        setupDragDrop('scanUploadArea', 'scanFileInput', handleScanFileSelect);
    </script>
</body>
</html>